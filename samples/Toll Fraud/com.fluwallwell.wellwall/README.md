

# **Application Details**

> **Package:** com.fluwallwell.wellwall     
> **Version:** 2.0.0    
> **Play Store:** https://play.google.com/store/apps/details?id=com.fluwallwell.wellwall    

## **Description**
Application of the `Joker` family which impersonate an wallpaper app and uses multiple layers of `dynamic code loading` to hide it's malicious behaviour.

After being executed for the first time, the application will load a file named `nodsfdfx` that will act as a **middleware** and load the third file with name `cpaoooop` which later is renamed to `four2003.mp3` and will execute the code that subscribe the user's phone number into the very known chinese premium website content "http://mcddmedia.com/".

### **Play Store's Description**
>Stop worrying about finding nice wallpaper    
>Here will be updated every day different wallpaper, every day to give you a different feeling    
>Function:    
>Daily updated wallpaper source    
>Set the desktop or lock screen wallpaper    

## **Architecture**
The analysed application with name **Well Wall** was built using **Flutter Framework** and because of this all it's UI as well as part of the logic business rules were made in **Dart** and compiled into a native library called `app.so`.

# **Analysis**

## **Suspicious permissions**
On opening the file `AndroidManifest.xml` it showed to have being using some interesting permissions that would make it capable of performing `Toll Fraud` behaviour, as well as two **dangerous permissions** that could be used for `Spyware` behaviour.

- `android.permission.READ_CONTACTS`
- `android.permission.WRITE_EXTERNAL_STORAGE`
- `android.permission.READ_EXTERNAL_STORAGE`
- `android.permission.CHANGE_NETWORK_STATE`
- `android.permission.ACCESS_NETWORK_STATE`
- `android.permission.READ_PHONE_STATE`
- `android.permission.BIND_NOTIFICATION_LISTENER_SERVICE`

## **The Suspicious Service**
On checking the entry points of the application, it was evident the suspicious service with a strange package name using the `BIND_NOTIFICATION_LISTENER_SERVICE` permission.

<p align="center">
  <img align="center" src="./images/5.png" />
  <br/>
  <strong>Image 5.png:</strong> Suspicious service on AndroidManifest.xml.
</p>

On analysing its code, it was possible to see that the service retrieves the notification and send it to a subclass of `qwewq.dsfdsds.asdasd.grerge.ICSGot` using the method **onStatus**, this used class is the variable `f` from `eter.sdgdf.sdasd.e` which we can see that it's instantiation is made using **Reflection** on obfuscated strings.

The strings were obfuscated using two layers of `Base64` enconding and `DES` encryption with they key "**com.fluw**", and after deobfuscating them the name of the subclass could be found: `qwewq.dsfdsds.asdasd.grerge.rerwewe`

Since the found class can't be found inside the application's APK and it's being loaded with **Reflection**, indicates that a `dynamic code loading` may be executed sometime.

### **Strings deobfuscation:** 
[CyberChef: Recipe](https://gchq.github.io/CyberChef/#recipe=Fork('%5C%5Cn','%5C%5Cn',false)From_Base64('A-Za-z0-9%2B/%3D',true)DES_Decrypt(%7B'option':'UTF8','string':'com.fluw'%7D,%7B'option':'UTF8','string':'00000000'%7D,'ECB','Raw','Raw'))
```
[(Base64->DES)->(Base64->DES)]->Plain text

"FT11fk03+fnvTmTrzBFj/XuGw4XcjBfq2PxHD3tdxDIlcCj6xyT8RDTeuoW7aSu+" -> "pANs3f+paY8Mb5DGYKxs0qpuw5aC7gSVYtByA0dEUzE=" -> "dalvik.system.DexClassLoader"
"jNr1CsGjbgU4hoTeQwUfxfoiBasrz4a18Vm7yk5Voc8=" -> "IaCtimS7gpu/Kwt2Z0Cucw==" -> "loadClass"
"PTht3dhItalmFL/gQ6H7WgIFEQ3I3z9c3BAZJRexYT8WzbiwJHw8dDQ3XEfTaeTzx5KRzwjsVwTxWbvKTlWhzw==" -> "78IKeeuOrF/GKruncX8xQXCWpRfWiHANVMyAHDC7Ix76DGIO3C6ktA==" -> "qwewq.dsfdsds.asdasd.grerge.rerwewe"
```

- [eter.sdgdf.sdasd.eretred](./images/6.png)
- [qwewq.dsfdsds.asdasd.grerge.ICSGot](./images/7.png)
- eter.sdgdf.sdasd.e
    -  [part #1](./images/8.png)
    -  [part #2](./images/9.png)



## **The Dynamic Code Loading**
On running the application on a device, some interesting behaviours could be identified. Just on opening the application, two suspicious requests were made and the response of them showed to be an **APK** and a **DEX**.


### **1th Request**

```
2021-04-03 15:26:35 GET http://giantchameleon.com/sdpdx/iefsz/?ts=1617459994326 ← 200 OK text/html 4.65k 175ms

Range: bytes=0-
User-Agent: PRDownloader 
Host: giantchameleon.com
Connection: Keep-Alive
Accept-Encoding: gzip
```

<p align="center">
  <img align="center" src="./images/1.png" />
  <br/>
  <strong>Image 1.png:</strong> Response of request with suspicious APK.
</p>

### **2th Request**

```
2021-04-03 15:27:54 GET http://s3.ap-southeast-1.amazonaws.com/aaa.sdk.v8/cpaoooop ← 200 OK application/octet-stream 66.81k 1.28s

Content-Type: application/octet-stream
User-Agent: Dalvik/2.1.0 (Linux; U; Android 11; sdk_gphone_x86_arm Build/RSR1.201013.001)
Host: s3.ap-southeast-1.amazonaws.com
Connection: Keep-Alive
Accept-Encoding: gzip
```
<p align="center">
  <img align="center" src="./images/2.png" />
  <br/>
  <strong>Image 2.png:</strong> Response of request with suspicious DEX.
</p>

### **Execution of DexClassLoader**

After some observation of the application on runtime, it was possible to identify the execution of two files using **DexClassLoader**, these files showed to be present inside the internal application's folder.

<p align="center">
    <img align="center" src="./images/3.png" />
    <br/>
    <strong>Image 3.png:</strong> Execution of files using DexClassLoader.
</p>


<div align="center">
    <img align="center" src="./images/4.png" />
    <br/>
    <strong>Image 4.png:</strong> Executed files inside /data/data/com.fluwallwell.wellwall/files.
</div>

## **The Middleware**
The APK file from the first request, showed to be the one with name `nodsfdfx` and on analysing it's code two main objectives were identified.

1. Retrieve all the notifications using the class `qwewq.dsfdsds.asdasd.grerge.rerwewe` which is instantiated in the main code and send them to `com.kjuary.vtijiujyc.action.Notice` through a broadcast.
2. Perform the second request, retrieving the `cpaoooop` dex file, renaming it to `four2003.mp3` and executing it.

The file acts as a **Middleware** connecting the main code of the application to the malicious code that will perform the `Toll Fraud` behaviour.

### **Download and Execution of cpaoooop:**
All the download and execution of the file `cpaoooop` happens at the class `com.third.A` which is executed by `qwewq.dsfdsds.asdasd.grerge.rerwewe` at the method `onActivityinit` that's called just after the instantiation of it at `eter.sdgdf.sdasd.e`.

The file is downloaded from a amazon instance "http://s3.ap-southeast-1.amazonaws.com/aaa.sdk.v8/cpaoooop" and saved on the application's internal storage with name `four2003.mp3`. 

On executing it the method `abc` from the class `x.y.z.M` is called.

- [qwewq.dsfdsds.asdasd.grerge.rerwewe](./images/10.png)
- com.third.A
    - [part #1](./images/11.png)
    - [part #2](./images/12.png)

## **The Malicious Code**
The file `cpaoooop` is where the `Toll Fraud` behaviour is executed and after analysing it's code, it was possible to identify a timeline of execution.

1. Startup
2. Installation Report
3. Creation of Broadcast Receiver    
   3.1 Validation of SIM Operator and definition of pinType
4. Instantiation of `org.hh.webview.utils.MyActivity`    
   4.1 Retrieve of Device's phone number    
   ..... 4.1.1 Try using TelephonyManager.getLine1Number    
   ..... 4.1.2 Try using AccountManager.getAccounts    
   ..... 4.1.3 Try using Phishing with a webview and javascript interface     
   4.2 Call of `org.hh.webview.TaskDriver.startTask`    
5. Execution of `org.hh.webview.TaskDriver.runTask`    
   5.1 Instantiation of `org.hh.webview.bean.Task`    
   5.2 The subscription    
   5.3 Upload of logs    
6. Execution of `org.hh.webview.TaskRunner`

Important URLs and strings can be found at `x.y.z.Config`.
- [x.y.z.Config](./images/19.png)

### **Startup** 
The startup of the malicious code happens at the method `abc` from `x.y.z.M` which will perform some configurations of the FacebookSDK and then start the class `org.hh.webview.TaskDriver` using the method `start`.

- [x.y.z.M.abc](./images/13.png)
- [org.hh.webview.TaskDriver.start](./images/14.png)

### **Installation report** 
One of the first actions of the malicious code, is to report the installation of the application, sending the informations about the device through HTTP request to "http://affi.mcddmedia.com/app/install/log".

- [org.hh.webview.TaskDriver.reportInstall](./images/15.png)
- [org.hh.webview.utils.Api.postDataByHeader](./images/16.png)

<div align="center">
    <img align="center" src="./images/20.png" />
    <br/>
    <strong>Image 20.png:</strong> Request reporting the installation.
</div>

### **Creation of Broadcast Receiver**
The broadcast receiver `com.kjuary.vtijiujyc.action.Notice` that receives all the notifications is created by the class `org.hh.webview.TaskDriver` at the method `initPinReceiver` that's executed at the start of the malicious flow.

The text from the notification is get and stored on the list `mMsgList` from the `org.hh.webview.TaskDriver`.

- [com.kjuary.vtijiujyc.action.Notice](./images/21.png)

#### **Validation of SIM Operator and definition of pinType**
Before of creating the broadcast receiver it performs a validation of the `SIM Operator` calling the method `isPin`, which will retrieves the `SIM Operator` from `DeviceUtils.getSimIso` and check if it matches with the string "**(502|419|232|270|262|420|460)\\d{2}|520(01|03|05|23)|424(02|03)|43(002|102)|413(02|11)**", then defining the value of `pinType`.

- [org.hh.webview.TaskDriver.isPin](./images/22.png)
- [DeviceUtils.getSimIso](./images/23.png)

### **Instantiation of `org.hh.webview.utils.MyActivity`**
At the startup along side with the **instalation report** and the **creation of the broadcast receiver** we have the instantiation of `org.hh.webview.utils.MyActivity` which is responsible for collect the device's phone number as well as start the method `startTask` from `org.hh.webview.TaskDriver`.

- [org.hh.webview.utils.MyActivity.onActivityResumed](./images/24.png)
- [org.hh.webview.utils.MyActivity.start](./images/25.png)
- [org.hh.webview.utils.MyActivity.ensure](./images/26.png)

On regards to the collection of the device's phone number the application has three ways on doing it and it happens at the method `initNum`, which each one triggers if the other fails, starting with the usage of **TelephonyManager**.

#### **Try using TelephonyManager.getLine1Number**
After validating that the value `key_phone` from the shared preferences is empty it will try to retrieve the device's phone number using the **TelephonyManager.getLine1Number** that's executed at `DeviceUtils.getNumber`.

- [org.hh.webview.utils.MyActivity.initNum](./images/27.png)
- [DeviceUtils.getNumber](./images/28.png)

#### **Try using AccountManager.getAccounts**
If the **TelephonyManager** fails, the application tries using **AccountManager.getAccounts**, saving all the found accounts into a log to be uploaded later and looking for an account of type **"im.thebot.messenger"** to retrieve the phone number.

- [org.hh.webview.utils.MyActivity.initNum](./images/29.png)

#### **Try using Phishing with a webview and javascript interface**
Last but not least, if the **AccountManager** fails as well, the application tries using `Phishing` to retrieve the device's phone number, opening a webview with a javascript interface attached and loading one of four different URLs with fake advertisement with a field to the user to insert the phone number.

- [org.hh.webview.utils.MyActivity.initNum](./images/30.png)
- [org.hh.webview.utils.TWeb.initWebView](./images/31.png)
- [org.hh.webview.utils.TWeb.PageJSInterface](./images/32.png)

<div align="center">
    <img align="center" src="./images/51.png" />
    <br/>
    <strong>Image 51.png:</strong> Phishing using, fake advertisement.
</div>

URLs:    
http://s3.ap-southeast-1.amazonaws.com/com.luckylottery.lp/sa.html    
http://s3.ap-southeast-1.amazonaws.com/com.luckylottery.lp/ae.html    
http://cpkroyehmusvtbbwrlp.s3.ap-southeast-1.amazonaws.com/index.html    
http://s3.ap-southeast-1.amazonaws.com/com.luckylottery.lp/kw.html    

#### **Call of `org.hh.webview.TaskDriver.startTask`**
At the `start` method it triggers two of the most important parts of the code, the start of the execution of the method `runTask` from `org.hh.webview.TaskDriver`.

As well as execute the `init` method from `org.hh.webview.TaskRunner` which will peform the configuration of the webview that will be used to subscribe the phone number into the premium website.

- [org.hh.webview.TaskDriver.startTask](./images/33.png)
- [org.hh.webview.TaskDriver.mInit](./images/36.png)
- org.hh.webview.TaskRunner.init
    - [part #1](./images/37.png)
    - [part #2](./images/38.png)
    - [part #3](./images/39.png)
    - [part #4](./images/40.png)
    - [part #5](./images/41.png)
    - [part #6](./images/42.png)


### **Execution of `org.hh.webview.TaskDriver.runTask`**
This method is resposible for executing multiple times an HTTP request to "http://affi.mcddmedia.com/app/offers/v2/get" in order to retrieve data from the offers that will be used to perform the subscription.

<div align="center">
    <img align="center" src="./images/43.png" />
    <br/>
    <strong>Image 43.png:</strong> Request get offers.
</div>

- org.hh.webview.TaskDriver.runTask
    - [part #1](./images/34.png)
    - [part #2](./images/35.png)
- [org.hh.webview.utils.Api.getTask](./images/44.png)
- [org.hh.webview.utils.Api.getDataByHeader](./images/45.png)

#### **Instantiation of `org.hh.webview.bean.Task`**
With the response of the mentioned request, the class `org.hh.webview.bean.Task` is instantiated, using the data from the offer to populate it.

- org.hh.webview.bean.Task.load
    - [part #1](./images/46.png)
    - [part #1](./images/47.png)

#### **The subscription**
After the instantiation of `org.hh.webview.bean.Task` and some validations the runnable `mRunnable` is executed by `mHammerHandler`, triggering the execution of the method `strike` from `org.hh.webview.TaskRunner`.

This method is responsible for loading the a url that was received by the offers request into the webview that was configurated at the method `init` from `org.hh.webview.TaskRunner`, performing then the subscription.

To complete the malicious flow the method `reportClick` is called at the end of `strike`, executing another HTTP request to "http://affi.mcddmedia.com/app/real/click" in order to confirm the click and subscription.

- [org.hh.webview.TaskDriver.mRunnable](./images/48.png)
- [org.hh.webview.TaskRunner.strike](./images/49.png)
- [org.hh.webview.TaskRunner.reportClick](./images/50.png)
- [org.hh.webview.utils.Api.getDataByHeader](./images/45.png)

#### **Upload of logs:** 
During the flow, multiple logs are created and stored into a **String Builder** using the methods `e` from `org.hh.webview.utils.DeviceUtils`.

At the end of the method `runTask` the method `report` from `org.hh.webview.utils.Api` is called, executing an HTTP request to "http://affi.mcddmedia.com/app/page/sms/log", sending all the stored logs, including debug logs, response from requests, data from the shared preferences and the retrieved accounts at the `org.hh.webview.utils.MyActivity`.

- [Saving logs into a String Builder](./images/17.png)
- [org.hh.webview.utils.Api.report](./images/18.png)
- [org.hh.webview.utils.Api.postDataByHeader](./images/16.png)